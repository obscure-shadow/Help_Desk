{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Help Desk</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="helpdesk">
      <h1> Welcome To Help Desk </h1>
      <div class="users" id="users">
        <h3>Online Students</h3>
  {% for usernames in online_users %}
  <p>{{ usernames.username }}</p>
  {% endfor %}
      </div>
      <div class='tickets' id="chat-log">
        {% for issue in issues %}
        <p>{{issue.user}}: {{issue.issue_desc}} <button id='{{ issue.pk }}' class='solved'> solved </button>
        </p>
        {% endfor%}
      </div>
      <hr>
      <input id="chat-message-input" name='issue' type="text" size="100"/><br/>
      <button id="chat-message-submit" disabled="disabled">Get Help</button>
    <form action="{% url 'logout' %}">
      <input type="submit" value="logout" />
    </form>
</body>
<script>
    var roomName = {{ room_name_json }};

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    var userSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');


    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
      if (message['message']['message'] !== ""){
          let ticket = document.createElement('div')
          let button = document.createElement('button')
          button.setAttribute('class','solved')
          button.setAttribute('id',`{{ issue.id }}`)
          button.textContent = 'Solved'
          ticket.textContent = (`${message['user']}: ${message['message']}`);
          ticket.appendChild(button)
          document.querySelector('#chat-log').appendChild(ticket)
        }
    };
    chatSocket.onclose = function(e) {
        console.log('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        let inputfield = document.querySelector('#chat-message-input').value
          let empty = false
        if (inputfield !== ''){
        document.querySelector('#chat-message-submit').removeAttribute("disabled")
        }
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
      document.querySelector('#chat-message-submit').setAttribute("disabled","disabled")
      var messageInputDom = document.querySelector('#chat-message-input');
      var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
          'message': {
            'user': `{{ user.username }}`,
            'message': message
          }
        }));

      function getCookie(name) {
          if (!document.cookie) {
            return null;
          }
          const token = document.cookie.split(';')
            .map(c => c.trim())
            .filter(c => c.startsWith(name + '='));

          if (token.length === 0) {
            return null;
          }
          return decodeURIComponent(token[0].split('=')[1]);
        }

      const csrftoken = getCookie('csrftoken')

      fetch('/chat/helpdesk', {
        method:"POST",
        body: JSON.stringify({
          'issue': message,
          'action': 'save'
         }),
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      messageInputDom.value = '';
    };
</script>
</html>
