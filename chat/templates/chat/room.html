{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="">
    <meta charset="utf-8"/>
    <title>Help Desk</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
  {% if user.is_authenticated %}
    <div class="helpdesk">
      <div class='heading'>
      <h1> Welcome To Help Desk, {{user.username}}!</h1>
      </div>
      <form action="{% url 'logout' %}" class="logout">
        <input type="submit" value="logout" />
      </form>
    </div>


    <div class="boxes">
      <div class="users" id="users">
        <div class='user-head'>
        <h3>Online Students</h3>
        </div>
          {% for usernames in online_users %}
          <p>{{ usernames.username }}</p>
          {% endfor %}
      </div>
      <div class='tickets' id="chat-log">
        {% for issue in issues %}
        <div class="issue" id ="{{ issue.pk }}">
          {{issue.user}}: {{issue.issue_desc}}
          {% if user.username == issue.user.username %}

          <button id='{{ issue.pk }}' onclick="solved(this.id)" class='solved'>
            Solved
          </button>
          {% endif %}
        </div>
        {% empty %}
         <div class="empty">
           <h3 class="empty-h3">All the problems have been solved!</h3>
         </div>
        {% endfor%}
    </div>
  </div>

  <div class="input">
    <div class="foot_desc">
      Please type a description and press get help to get help! :
    </div>
    <div class="foot_inp">
    <input id="chat-message-input" name='issue' type="text" size="100"/><br/>
    <button id="chat-message-submit" class="button" disabled="disabled">Get Help</button>
    </div>
  </div>
    {% else %}
    {% include "login.html" %}
    {% endif %}
</body>

<script>
    var roomName = {{ room_name_json }};

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    var userSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');


    chatSocket.onmessage = function(e) {
      var data = JSON.parse(e.data);
      var message = data['message'];
      let type = data['message']['type']
      if (type === "message"){
            //let ticket = document.createElement('div')
            //let button = document.createElement('button')
            //button.setAttribute('class','solved')
            //button.setAttribute('id',`{{ issue.id }}`)
            //button.setAttribute('onclick', 'solved(this.id)')
            //button.textContent = 'Solved'
            //ticket.setAttribute('class','issue')
            //ticket.textContent = (`${message['user']}: ${message['message']}`);
            //ticket.appendChild(button)
            //ticket.appendChild(document.createElement('hr'))
            //document.querySelector('#chat-log').appendChild(ticket)
            location.reload()
          }
      else if (type === "solved"){
        document.getElementById(message['message']).remove()
      }
    };
    chatSocket.onclose = function(e) {
        console.log('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        let inputfield = document.querySelector('#chat-message-input').value
          let empty = false
        if (inputfield !== ''){
        document.querySelector('#chat-message-submit').removeAttribute("disabled")
        }
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
      document.querySelector('#chat-message-submit').setAttribute("disabled","disabled")
      var messageInputDom = document.querySelector('#chat-message-input');
      var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
          'message': {
            'user': `{{ user.username }}`,
            'message': message,
            'type': 'message'
          }
        }));


      fetch('/chat/helpdesk', {
        method:"POST",
        body: JSON.stringify({
          'issue': message,
          'action': 'save'
         }),
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      messageInputDom.value = '';
    };

  function getCookie(name) {
          if (!document.cookie) {
            return null;
          }
          const token = document.cookie.split(';')
            .map(c => c.trim())
            .filter(c => c.startsWith(name + '='));

          if (token.length === 0) {
            return null;
          }
          return decodeURIComponent(token[0].split('=')[1]);
        }

  const csrftoken = getCookie('csrftoken')

  let solved = (id) => {
      fetch('/chat/helpdesk', {
      method:"POST",
      body: JSON.stringify({
        'action': 'solved',
        'id': id
        }),
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    // document.getElementById(id).remove()
    chatSocket.send(JSON.stringify({
      'message': {
        'message': id,
        'type': 'solved'
      }
    }))
 }

</script>
</html>
